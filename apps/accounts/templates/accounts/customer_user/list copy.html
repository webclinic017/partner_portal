{% extends "base_logged.html" %}
{% load static widget_tweaks %}

{% block extra_stylesheet %}
{% endblock %}


{% block content %}

<div class="container-xl px-4 py-5">

    <div class="row text-light">

        <div class="col-sm-6 mb-10">
            <h4 class="text-primary">
                Usuários OxenteTV
            </h4>
        </div>

        <div class="col-sm-6 mb-30" >
            
            <div class="d-block d-sm-none">
                <div class="d-grid gap-2">
                    <a class="btn btn-lg btn-outline-secondary"  href="{% url 'accounts:customeruser_create' %}">
                        <i class="far fa-plus-square"></i> Adicionar novo usuário
                    </a>
                </div>
            </div>

            <div class="d-none d-sm-block text-end">
                <a class="btn btn-primary" href="{% url 'accounts:customeruser_create' %}">
                    <small><i class="fas fa-plus"></i></small>
                    Adicionar usuário
                    
                </a>
            </div>
            
        </div>


        <div class="col-lg-12 mb-10" hidden>

            <form action="" method="get">
                <div class="row mb-3">
                
                    <div class="col-md-2 col-12">
                        <div class="mb-3">
                            <label class="label_input_search" for="status">Tipo</label>
                            <select onchange="this.form.submit()" class="form-select form-select-sm" id="doc_type_filter" name="doc_type" aria-label="">
                                <option value="">Todos</option>
                                <option value="1">Termo de adesão</option>
                                <option value="2">Contrato de permanência</option>
                                <option value="3">Distrato contratual</option>
                            </select>
                            
                        </div>
                    </div>

                    <div class="col-md-2 col-12">
                        <div class="mb-3">
                            <label class="label_input_search" for="status">Status</label>
                            <select onchange="this.form.submit()" class="form-select form-select-sm" id="status_filter" name="status" aria-label="">
                                <option value="">Todos</option>
                                <option value="signed">Assinado</option>
                                <option value="pending">Em pendência</option>
                            </select>
                            
                        </div>
                    </div>
                    
                    <div class="col-md-2 col-12">
                        <div class="mb-3">
                            <label class="label_input_search" for="created_by">Criado por</label>
                            <select onchange="this.form.submit()" class="form-select form-select-sm form-select form-select-sm-sm" id="created_by_filter" name="created_by" aria-label="">
                                <option value="">Todos</option>
                                {% for item in user_list %}
                                <option value="{{ item.doc_template__created_by }}">{{ item.doc_template__created_by__first_name }}</option>
                                {% endfor %}
                            </select>
                            
                        </div>
                    </div>

                    <div class="col-md-2 col-12">
                        <div class="mb-3">
                            <label class="label_input_search" for="start_created_at">Início</label>
                            <input type="date" class="form-control form-control-sm" name="start_created_at" id="id_start_created_at" value="{% if request.GET.start_created_at %}{{ request.GET.start_created_at }}{% endif %}" onchange="this.form.submit()">
                        </div>
                    </div>

                    <div class="col-md-2 col-12">
                        <div class="mb-3">
                            <label class="label_input_search" for="end_created_at">Fim</label>
                            <input type="date" class="form-control form-control-sm" name="end_created_at" id="id_end_created_at" value="{% if request.GET.end_created_at %}{{ request.GET.end_created_at }}{% endif %}" onchange="this.form.submit()">
                            
                        </div>
                    </div>

                    <div class="col-md-2 col-12">
                        <label class="label_input_search" for="contract_number">Nº contrato</label>
                        <div class="input-group mb-3">                            
                            <input value="{{ request.GET.contract_number }}" name="contract_number" id="filter_contract_number" placeholder="Contrato"  type="text" class="form-control form-control-sm" aria-describedby="button-addon2">
                            <button class="btn btn-sm btn-outline-secondary" type="submit" id="button-addon2"  style="border: 1px solid #ced4da !important;">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>

                    </div>

                    {% if request.GET.doc_type or request.GET.start_created_at  or request.GET.end_created_at or request.GET.status or request.GET.contract_number or request.GET.created_by %}
                    <div class="col-12 mb-3">
                        <a href=".">
                            <span class="badge rounded-pill bg-light text-dark">
                                <i class="far fa-times-circle"></i>
                                Limpar filtros
                            </span>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </form>

        </div>

        <div class="col-md-12 mb-10">
            <div class="d-none d-sm-block d-sm-none d-md-block d-md-none d-lg-block">
                <div class="border-0 text-secondary p-3">
                    <div class="row">
                        
                        <div class="col-md-3 col-12">
                            <div>
                                <small class="fw-bold">NOME COMPLETO</small>
                            </div>
                        </div>
    
                        <div class="col-md-2 col-12">
                            <div >
                                <small class="fw-bold">USUÁRIO</small>
                            </div>
                            
                        </div>
                        
                        <div class="col-md-2 col-12">
                            <div>
                                <small class="fw-bold">SENHA</small>
                            </div>
                        </div>
                        
                        <div class="col-md-2 col-12">
                            <div>
                                <small class="fw-bold">STATUS</small>
                            </div>
    
                        </div>

                        <div class="col-md-3 col-12">
                            <div>
                                <small class="fw-bold">AÇÕES</small>
                            </div>
    
                        </div>
    
                    </div>
                </div>
            </div>
            
        </div>

        {% for item in object_list %}
        <div class="col-md-12 mb-15" id="id-row-item-{{ item.id }}">
            <div class="bg-dark text-light border-0 shadow-sm p-3 rounded-4">
                <div class="row">
                    
                    <div class="col-md-3 col-12 mb-10">
                        <div class="text-muted ">
                            <small>Nome completo</small>
                        </div>
                        <div>
                            {{ item.full_name }}
                        </div>
                    </div>

                    <div class="col-md-2 col-12 mb-10">
                        <div class="text-muted ">
                            <small>Usuário</small>
                        </div>
                        
                        <div>
                            {{ item.username }}
                        </div>
                    </div>
                    
                    <div class="col-md-2 col-12 mb-10">
                        <div class="text-muted ">
                            <small>Senha</small>
                        </div>
                        <div id="input-group-{{ item.id }}">

                            <div class="input-group pr-20">
                                <input id="id_input_password_{{ item.id }}" type="password" class="form-control form-control-sm bg-dark text-light border border-secondary" value="{{ item.password }}" readonly>
                                <button class="btn btn-sm btn-outline-secondary" type="button" onclick="showPassword(this, 'id_input_password_{{ item.id }}');">
                                    <small><i class="far fa-eye"></i></small>
                                </button>
                                <!-- <button class="btn btn-sm btn-outline-secondary" onclick="openModalCustomerUserPassword('{{ item.id }}', '{{ item.password }}')">
                                    <small><i class="fas fa-pen"></i></small>
                                </button> -->
                            </div>
                            
                        </div>
                    </div>
                    
                    <div class="col-md-2 col-12 mb-10">
                        <div class="text-muted ">
                            <small>Status</small>
                        </div>
                        <div>
                            {% if item.status == '1' %}
                            <b class=" text-success">{{ item.get_status_display.title }}</b>
                            
                            {% else %}
                            <b class="text-danger" >{{ item.get_status_display.title }}</b>
                            
                            {% endif %}
                        </div>

                    </div>
                    
                    <div class="col-md-3 col-12 mb-10">
                        <div class="text-muted ">
                            <small>Ações</small>
                        </div>
                        <div class="">
                            <!-- <button class="btn btn-sm btn-outline-success btnDelete" data-id="{{ item.id }}">
                                Desbloquear
                            </button> -->
                            <button class="btn btn-sm btn-outline-warning btnDelete" data-id="{{ item.id }}">
                                Bloquear
                            </button>
                            <a class="btn btn-sm btn-outline-info" href="{% url 'accounts:customeruser_update' item.pk %}">
                                Editar
                            </a>
                            <button class="btn btn-sm btn-outline-danger btnDelete" data-id="{{ item.id }}">
                                Excluir
                            </button>
                            <!-- <span class="badge rounded-pill bg-danger pointer pr-10 pl-10">Excluir</span> -->
                        </div>

                    </div>

                </div>
            </div>
        </div>
        {% empty %}
        
        <div class="col-md-12 mb-15">
            <div class="alert alert-warning" role="alert">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2" viewBox="0 0 16 16" role="img" aria-label="Warning:">
                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                </svg>
                0 resultados para esse(s) filtro(s).
            </div>
        </div>

        {% endfor %}
        
        <div class="col-lg-12 mb-15 mt-20">
            
            <div class="row justify-content-between">
                
                <div class="col-md-3 col-12 mb-3 text-muted">
                    Mostrando {{ object_list|length }} de {{ paginator.count }}
                </div>

                {% if is_paginated %}
                <div class="col-md-4">

                    <div class="input-group mb-3">
                        {% if page_obj.has_previous %}
                        <a href="?page={{ page_obj.previous_page_number }}&doc_type={{ request.GET.doc_type }}&status={{ request.GET.status }}&start_created_at={{ request.GET.start_created_at }}&end_created_at={{ request.GET.end_created_at }}&created_by={{ request.GET.created_by }}&contract_number={{request.GET.contract_number}}" class="btn btn-outline-secondary " style="border: 1px solid #ced4da !important;">
                            <i class="fas fa-arrow-left"></i>
                        </a>
                        {% else %}
                        <button disabled class="btn btn-outline-secondary" type="button" style="border: 1px solid #ced4da !important;">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        {% endif %}
                        
                        <select class="form-select text-center" id="page_filter">>
                            {% for i in paginator.page_range %}
                            <option value="?page={{ i }}&doc_type={{ request.GET.doc_type }}&status={{ request.GET.status }}&start_created_at={{ request.GET.start_created_at }}&end_created_at={{ request.GET.end_created_at }}&created_by={{ request.GET.created_by }}&contract_number={{request.GET.contract_number}}" {% if page_obj.number == i %}selected {% endif %}>Página {{i}} de {{ paginator.num_pages }}</option>
                            {% endfor %}
                        </select>
                        
                        {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}&doc_type={{ request.GET.doc_type }}&status={{ request.GET.status }}&start_created_at={{ request.GET.start_created_at }}&end_created_at={{ request.GET.end_created_at }}&created_by={{ request.GET.created_by }}&contract_number={{request.GET.contract_number}}" class="btn btn-outline-secondary " style="border: 1px solid #ced4da !important;">
                            <i class="fas fa-arrow-right"></i>
                        </a>
                        {% else %}
                        <button disabled class="btn btn-outline-secondary" type="button" style="border: 1px solid #ced4da !important;">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        {% endif %}
                      </div>

                </div>
                {% endif %}

            </div>

        </div>

    </div>

</div>




<div class="modal fade" id="modalCustomerUserUpdatePassword" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="modalCustomerUserUpdatePasswordLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light p-3">
            <form action="{% url 'accounts:customeruser_update_password' %}" method="POST" id="id_form_customeruser_update_password">
                <div class="modal-header border-0 bg-transparent">
                    <h5 class="modal-title" id="modalCustomerUserUpdatePasswordLabel">Alterar senha</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body">

                    <input type="hidden" id="id_form_id" name="form_id" value="">

                    <div class="form-floating mb-3">
                        <input type="text" class="form-control bg-dark text-light border border-primary" id="id_current_password" name="current_password" readonly>
                        <label for="floatingPassword">Senha atual</label>
                    </div>

                    <div class="form-floating mb-3">
                        <input required type="text" minlength="6" class="form-control bg-dark text-light border border-primary" id="id_new_password" name="new_password" placeholder="Password">
                        <label for="floatingPassword">Nova senha</label>
                    </div>
                    
                </div>

                <div class="modal-footer border-0 bg-transparent">
                    <button type="button" class="btn btn-default text-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="submit" class="btn btn-outline-primary">Alterar senha</button>
                </div>
            </form>

        </div>
    </div>
</div>


<div class="modal fade" id="modalSuccess" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content border-0 ">
          
        <div class="modal-header bg-success border-0 p-3 text-center">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-12 text-center text-light" style="font-size: 70px;">
                        <i class="lni lni-checkmark-circle"></i>
                    </div>
                </div>
            </div>
            
        </div>
        <div class="modal-body ">
            <div class="row">

                <div class="col-12 mb-3">
                    
                    <h5 class="text-center text-success mt-3 mb-3">
                        Sucesso!
                    </h5>
                    <p class="text-center mb-3">
                        Senha alterada com sucesso.
                    </p>
                    <div class="d-grid gap-2 col-11 mx-auto">
                        <button type="button" class="btn btn-outline-success rounded-5" data-bs-dismiss="modal">
                            Okay
                        </button>
                    </div>

                </div>

            </div>
        </div>
      </div>
    </div>
</div>


<div class="offcanvas offcanvas-end p-3 bg-dark text-muted" tabindex="-1" id="offcanvasWithBackdrop" aria-labelledby="offcanvasWithBackdropLabel">
    <form action="." method="POST">

        <div class="offcanvas-header">
            <h5 class="offcanvas-title text-primary" id="offcanvasWithBackdropLabel">
                Adicionar novo usuário
            </h5>
            <span  data-bs-dismiss="offcanvas" aria-label="Close" class="text-light pointer">
                <i class="fas fa-times"></i>
            </span>
        </div>

        <div class="offcanvas-body">
            <p class="mb-3 text-light">
                Para fornecer acesso a Oxente TV é necessário preencher algumas informações básicas.
            </p>
            
            {% csrf_token %}

            {% for field in form %}
            <div class="mb-3">
                <div class="form-floating">
                    {% render_field field placeholder="text.label" class+="form-control bg-dark border border-secondary text-light" %}
                    <label>{{ field.label }}</label>
                </div>
                <div class="form-text">{{ field.help_text | capfirst}}</div>
            </div>
            {% endfor %}
            
        </div>

        <div class="offcanvas-footer p-3 text-end">
            
            <button class="btn btn-default text-secondary btn-lg"   data-bs-dismiss="offcanvas" aria-label="Close" >
                Cancelar
                <!-- <i class="lni lni-save"></i> -->
            </button>

            <button class="btn btn-outline-primary btn-lg" type="submit">
                <i class="lni lni-save"></i>
                Salvar
            </button>
            
        </div>

    </form>
</div>


{% endblock %}

{% block extra_scrypts %}
<script>
    var modalCustomerUserUpdatePassword = new bootstrap.Modal(document.getElementById('modalCustomerUserUpdatePassword'), {
        keyboard: false
    });

    var modalSuccess = new bootstrap.Modal(document.getElementById('modalSuccess'), {
        keyboard: false
    });

    function openModalCustomerUserPassword(customer_id, customer_password) {

        $('input[name=form_id]').val(customer_id);
        $('input[name=current_password').val(customer_password);
        $('input[name=new_password').val('');
        modalCustomerUserUpdatePassword.show();

    }


    function showPassword(element, input) {
        var x = document.getElementById(input);
        if (x.type === "password") {
            x.type = "text";
            $(element).html('<small><i class="far fa-eye-slash"></i></small>');
        } else {
            x.type = "password";
            $(element).html('<small><i class="far fa-eye"></i></small>');
        }
    }


    function banCustomer(customer_id) {
        
    }

    
    function updateContextRow(objectId, newPassword) {
        $(`#input-group-${objectId} div`).remove();
        
        let context = `
        <div class="input-group pr-20">
            <input id="id_input_password_${objectId}" type="password" class="form-control form-control-sm bg-dark text-light border border-secondary" value="${newPassword}">
            <button class="btn btn-sm btn-outline-secondary" type="button" onclick="showPassword(this, 'id_input_password_${ objectId }');">
                <small><i class="far fa-eye"></i></small>
            </button>
            <button class="btn btn-sm btn-outline-secondary" onclick="openModalCustomerUserPassword('${ objectId }', '${newPassword}')">
                <small><i class="fas fa-pen"></i></small>
            </button>
        </div>
        `;

        $(`#input-group-${objectId}`).append(context);
    }

    

    $("form#id_form_customeruser_update_password").submit(function(e){
        e.preventDefault();
        var form = $(this);
        var objectId = $(form).find('input[name="form_id"]').val();
        var newPassword = $(form).find('input[name="new_password"]').val();
        var data = {
            'form_id': objectId,
            'new_password': newPassword
        };

        fetch(form.attr('action'), {
            method: form.attr('method'),
            credentials: "same-origin",
            headers: {
                "X-CSRFToken": getCookie("csrftoken"),
                "Accept": "application/json",
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            console.log(data);
            if (data.error) {
                console.log("Erro");
            }else {
                updateContextRow(objectId, newPassword);
                modalCustomerUserUpdatePassword.hide();
                modalSuccess.show();
            };
            
        })
        .catch(console.error);
        
    });


    $('.btnDelete').on('click', function (e) {
        e.preventDefault();
        var id = $(this).data('id');
        // console.log(id);
        alert(id);
        // $('#myModal').data('id', id).modal('show');
    });

</script>
{% endblock %}
